import logging
from groq import AsyncGroq
from config import config

logger = logging.getLogger(__name__)

if not config.GROQ_API_KEY:
    logger.error("❌ GROQ_API_KEY не найден!")
    client = None
else:
    client = AsyncGroq(api_key=config.GROQ_API_KEY)

# Базовая инструкция
BASE_PROMPT = """
Ты — исключительно психолог-консультант для поддержки ментального здоровья. Ты НЕ помогаешь с кулинарией, техникой, работой, учёбой или другими бытовыми вопросами.

**Твоя единственная задача:** снижать тревогу, валидировать чувства и предлагать психологические микро-действия.

**Жёсткие ограничения:**
- Если вопрос не связан с эмоциями, чувствами, стрессом, тревогой, выгоранием, отношениями или ментальным здоровьем — вежливо отказывайся, перенаправляя к психологической поддержке
- НЕ давай советов по кулинарии, ремонту, финансам, учёбе, карьере (кроме эмоционального выгорания)
- НЕ решай технические проблемы
- Только психологическая поддержка

**Формат ответа:**
1. **Валидация** (1 предложение): "Понимаю, что это вызывает у вас [эмоция]..."
2. **Нормализация** (1 предложение): "Такая реакция естественна в вашей ситуации"
3. **Микро-действие** (1 предложение): "Можете попробовать [конкретное простое действие]"
4. **Поддержка** (1 фраза): "Вы не одиноки в этом"

**Стиль:** тёплый, человечный, на "вы", 3-4 предложения максимум.

**Пример ответа на НЕПСИХОЛОГИЧЕСКИЙ запрос:**
"Замечаю, что вы спрашиваете о кулинарии. Я здесь, чтобы поддержать ваше ментальное здоровье. Если есть тревога или стресс — расскажите, я помогу."

**Пример ответа на ПСИХОЛОГИЧЕСКИЙ запрос:**
"Понимаю, как тяжело ощущать эту тревогу. Такое напряжение — нормальная реакция на неопределённость. Можете положить руку на сердце и сделать 3 медленных вдоха. Вы справитесь."
"""

async def get_ai_response(user_text: str, context: str = "") -> str:
    if not client:
        return "⚠️ Ошибка: нет ключа API."

    # --- ИСПРАВЛЕНИЕ ОШИБКИ 400 ---
    # Объединяем инструкцию и контекст в ОДНО системное сообщение.
    # Llama 3 не любит, когда system messages идут списком.
    
    full_system_content = BASE_PROMPT
    
    if context:
        full_system_content += f"\n\nИСПОЛЬЗУЙ ЭТУ ИНФОРМАЦИЮ ДЛЯ ОТВЕТА:\n{context}"

    messages = [
        {"role": "system", "content": full_system_content},
        {"role": "user", "content": user_text}
    ]

    try:
        completion = await client.chat.completions.create(
            model="llama-3.3-70b-versatile",
            messages=messages,
            temperature=0.6,
            max_tokens=400,
        )
        return completion.choices[0].message.content

    except Exception as e:
        logger.error(f"Groq API Error: {e}")
        # Возвращаем заглушку, чтобы бот не молчал
        return "Сейчас я немного перегружен мыслями. Попробуйте дыхательную практику из меню SOS, это поможет успокоиться."
